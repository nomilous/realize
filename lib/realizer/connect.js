// Generated by CoffeeScript 1.6.3
var connect, deferred, error, notice;

deferred = require('also').deferred;

notice = require('notice');

error = require('./error');

module.exports = connect = deferred(function(action, realizer) {
  var notify, opts, realizerFn, reject, resolve;
  resolve = action.resolve, reject = action.reject, notify = action.notify;
  opts = realizer.opts, realizerFn = realizer.realizerFn;
  return process.nextTick(function() {
    var key, origin;
    if (opts.connect == null) {
      opts.standalone = true;
      return resolve({
        realizerFn: realizerFn,
        uplink: notice.create(opts.uuid),
        opts: opts
      });
    }
    opts.connect.address = opts.connect.hostname;
    origin = {};
    for (key in opts) {
      if (key === 'connect') {
        continue;
      }
      origin[key] = opts[key];
    }
    opts.origin = origin;
    return notice.connect(opts.uuid, opts, function(err, uplink) {
      if (err != null) {
        return reject(error({
          errno: err.errno || 106,
          code: err.code || 'ENOUPLINK',
          message: err.message
        }));
      }
      return resolve({
        realizerFn: realizerFn,
        uplink: uplink,
        opts: opts
      });
    });
  });
});
