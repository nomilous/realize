#! /usr/bin/env coffee

Hub = require('notice').hub 

    client: 
        capsule:
            realize: {}

Hub.create 

    title: 'Old Mother Goose'
    listen: 
        adaptor:  'socket.io'
        port:     30201
        secret:   'âˆ†'

    (err, omg) -> 

        return err.toString() if err?

        omg.use 

            title: 'EavesDropper'
            (next, capsule, {origin}) -> 

                origin.capsuleCount ||= 0
                origin.capsuleCount++
                console.log "[#{capsule._type}] #{capsule[capsule._type]} (capsuleCount: #{origin.capsuleCount})"
                

                #
                # pretend to be objective
                #

                if capsule.control == 'start'

                    setTimeout (-> 

                        #
                        # call realizer to load phrase tree
                        #

                        origin.realize 'load'

                    ), 200
                    
                    return next()


                if capsule.phrase == 'phrase::recurse:end'

                    #
                    # realizer done loading phrase tree
                    #

                    for path of capsule.tokens
                        root = capsule.tokens[path].uuid
                        break

                    console.log "\ncalling run: #{root}\n"               
                    origin.realize 'run', uuid: root

                    return next()


                # console.log origin
                # console.log capsule
                next()
