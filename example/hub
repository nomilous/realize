#! /usr/bin/env coffee

Hub = require('notice').hub 

    client: 
        capsule:
            realize: {}

Hub.create 

    title: 'Old Mother Goose'
    listen: 
        adaptor:  'socket.io'
        port:     30201
        secret:   'âˆ†'

    (err, omg) -> 

        return err.toString() if err?

        omg.use 

            title: 'EavesDropper'
            (next, capsule, traverse) -> 

                console.log "[#{capsule._type}] #{capsule[capsule._type]}"

                #
                # pretend to be objective
                #

                if capsule.control == 'start'

                    setTimeout (-> 

                        #
                        # call realizer to load phrase tree
                        #

                        traverse.origin.realize 'load'

                    ), 200
                    return next()


                if capsule.phrase == 'phrase::recurse:end'

                    #
                    # realizer done loading phrase tree
                    #

                    for path of capsule.tokens
                        root = capsule.tokens[path].uuid
                        break


                    console.log "\ncalling run: #{root}\n"
                    
                    traverse.origin.realize 'run', 
                        uuid: root
                        params: 
                            eachWaits: 1000 

                    return next()


                # console.log traverse.origin
                # console.log capsule
                next()
